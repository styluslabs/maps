name: Ascend Maps CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  #workflow_dispatch:  # for manual run

jobs:
  tangram-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y libgl1-mesa-dev mesa-common-dev libfontconfig1-dev libcurl4-openssl-dev
    - name: tangram tests
      run: make -f tests.mk DEBUG=1

  linux-build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y libgl1-mesa-dev mesa-common-dev libfontconfig1-dev libcurl4-openssl-dev libxi-dev libdbus-1-dev
    - name: Build tgz
      run: make real_tgz

  android-build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      run: git clone --recurse-submodules https://github.com/styluslabs/maps
      #uses: actions/checkout@v4
      #with:
      #  submodules: recursive
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    - name: Gradle Assemble
      run: ./gww assembleRelease
      working-directory: maps/app/android
    - name: Upload release APK
      uses: actions/upload-artifact@v4
      with:
        name: app-release-apk
        path: maps/app/android/app/build/outputs/apk/release/app-release.apk

  windows-build:
    runs-on: windows-latest
    steps:
    - name: Checkout maps
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: maps
    - name: Download curl and zlib sources
      shell: powershell
      run: |
        # Download and extract curl (latest version as of early 2026)
        curl.exe -L -o curl.zip https://github.com/curl/curl/releases/download/curl-8_18_0/curl-8.18.0.zip
        Expand-Archive curl.zip -DestinationPath .
        Rename-Item "curl-8.18.0" "curl"

        # Download and extract zlib
        curl.exe -L -o zlib.zip https://github.com/madler/zlib/archive/refs/tags/v1.3.1.zip
        Expand-Archive zlib.zip -DestinationPath .
        Rename-Item "zlib-1.3.1" "zlib"
    - name: Build zlib (Static)
      shell: pwsh
      run: |
        cd zlib
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=OFF
        cmake --build build --config Release
    - name: Build libcurl
      shell: pwsh
      run: |
        cd curl
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_SHARED_LIBS=ON `
          -DBUILD_CURL_EXE=ON `
          -DCURL_ZLIB=ON `
          -DZLIB_INCLUDE_DIR="$pwd\..\zlib;$pwd\..\zlib\build" `
          -DZLIB_LIBRARY="$pwd\..\zlib\build\Release\zlibstatic.lib" `
          -DCURL_USE_SCHANNEL=ON `
          -DCURL_WINDOWS_SSPI=ON `
          -DENABLE_IPV6=ON `
          -DCURL_USE_LIBPSL=OFF
        cmake --build build --config Release
    - name: Download make.exe
      run: curl -L -o make.exe https://github.com/styluslabs/maps/releases/download/alpha-1/make.exe
    - name: Build Maps
      working-directory: maps
      env:
        SHELL: 'C:\Windows\System32\cmd.exe'
      #  CURL_INCLUDE_DIR: ${{ github.workspace }}\curl\build\include
      #  CURL_LIB_DIR:     ${{ github.workspace }}\curl\build\lib\Release
      #  CURL_LIB:         libcurl.lib
      run: |
           ..\make.exe --version
           ..\make.exe zip
    - name: Upload release ZIP
      uses: actions/upload-artifact@v4
      with:
        name: release-win64-zip
        path: maps/build/Release/*.zip
